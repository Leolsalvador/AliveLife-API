name: Deploy para Servidor

on:
  push:
    branches:
      - main  # Ou a branch que você usa para deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do Código
      uses: actions/checkout@v3

    - name: Configurar SSH
      uses: webfactory/ssh-agent@v0.8.1
      with:
        ssh-private-key: ${{ secrets.DEPLOY_KEY }}

    - name: Remover Pasta no Servidor
      run: |
        ssh -o StrictHostKeyChecking=no root@142.93.72.190 "rm -rf /AliveLife"

    - name: Subir Arquivos para o Servidor
      run: |
        scp -r . usuario@ip-servidor:/AliveLife
      
    - name: Criar .env no Servidor
      run: |
        ssh -o StrictHostKeyChecking=no root@142.93.72.190 "
        echo 'DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}' > /AliveLife/.env &&
        echo 'HOST_DATABASE=${{ secrets.HOST_DATABASE }}' >> /AliveLife/.env &&
        echo 'NAME_DATABASE=${{ secrets.NAME_DATABASE }}' >> /AliveLife/.env &&
        echo 'USER_DATABASE=${{ secrets.USER_DATABASE }}' >> /AliveLife/.env &&
        echo 'PASSWORD_DATABASE=${{ secrets.PASSWORD_DATABASE }}' >> /AliveLife/.env &&
        echo 'KEY_CRYPTOGRAPHY=${{ secrets.KEY_CRYPTOGRAPHY }}' >> /AliveLife/.env &&
        echo 'IV_CRYPTOGRAPHY=${{ secrets.IV_CRYPTOGRAPHY }}' >> /AliveLife/.env &&
        echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> /AliveLife/.env
        "

    - name: Construir e Rodar Docker no Servidor
      run: |
        ssh -o StrictHostKeyChecking=no root@142.93.72.190 "
        cd /AliveLife &&
        docker-compose down &&
        docker-compose up -d --build
        "
